<!DOCTYPE html>
<html lang="mr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üö© ‡§π‡§®‡•Å‡§Æ‡§æ‡§® ‡§§‡§∞‡•Å‡§£ ‡§Æ‡§Ç‡§°‡§≥, ‡§¶‡•å‡§≤‡§§ ‡§®‡§ó‡§∞ üö©</title>

  <!-- Google Font: Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Firebase v8 (CDN ‚Äì bundler ‡§∂‡§ø‡§µ‡§æ‡§Ø ‡§ö‡§æ‡§≤‡§§‡§Ç) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root { --orange:#ff9933; --red:#ff3300; }
    * { box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background: #fff8dc;
      margin: 0; padding: 0;
      text-align: center;
    }
    header {
      position: sticky; top: 0;
      background: linear-gradient(90deg, var(--orange), var(--red));
      color: #fff; padding: 18px 20px; font-size: 22px; font-weight: 700;
    }
    #balance {
      position: absolute; right: 20px; top: 18px;
      background: #222; color:#fff; padding: 8px 14px; border-radius: 8px;
      font-size: 18px; font-weight: 600;
    }
    .wrap { max-width: 1100px; margin: 0 auto; padding: 16px; }
    h2 { margin: 16px 0 8px; font-weight: 700; }
    .form-row { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
    input, select {
      padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 6px; min-width: 180px;
    }
    button {
      background: linear-gradient(45deg, var(--orange), var(--red));
      border: none; color: #fff; padding: 10px 16px; border-radius: 6px;
      font-size: 16px; font-weight: 600; cursor: pointer; transition: .2s;
    }
    button:hover { opacity: .9; }
    #status { margin: 8px 0; min-height: 20px; font-size: 14px; }

    table { width: 100%; border-collapse: collapse; margin: 14px 0 24px; font-size: 16px; }
    th, td { border: 2px solid #333; padding: 10px; text-align: left; }
    th { background: #f0f0f0; }
    .credit { background: #d4f8d4; }  /* ‡§π‡§ø‡§∞‡§µ‡§æ */
    .debit  { background: #f8d4d4; }  /* ‡§≤‡§æ‡§≤  */

    .charts { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 800px){ .charts { grid-template-columns: 1fr 1fr; } }
    canvas {
      background: #fff; border-radius: 10px; padding: 12px;
      box-shadow: 0 0 10px #00000022;
    }
  </style>
</head>
<body>
  <header>
    üö© ‡§π‡§®‡•Å‡§Æ‡§æ‡§® ‡§§‡§∞‡•Å‡§£ ‡§Æ‡§Ç‡§°‡§≥, ‡§¶‡•å‡§≤‡§§ ‡§®‡§ó‡§∞ üö©
    <div id="balance">‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï: ‚Çπ0</div>
  </header>

  <div class="wrap">
    <h2>‡§®‡•ã‡§Ç‡§¶ ‡§ú‡•ã‡§°‡§æ</h2>
    <div class="form-row">
      <input type="date" id="date" />
      <input type="number" id="amount" placeholder="‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)" />
      <input type="text" id="note" placeholder="‡§®‡•ã‡§Ç‡§¶" />
      <select id="type">
        <option value="credit">Credit (‡§Ü‡§µ‡§ï)</option>
        <option value="debit">Debit (‡§ñ‡§∞‡•ç‡§ö)</option>
      </select>
      <button id="addBtn">‡§®‡•ã‡§Ç‡§¶ ‡§ú‡•ã‡§°‡§æ</button>
      <button id="csvBtn">üì• ‡§á‡§§‡§ø‡§π‡§æ‡§∏ ‡§°‡§æ‡§â‡§®‡§≤‡•ã‡§° (CSV)</button>
    </div>
    <div id="status"></div>

    <h2>‡§∏‡§∞‡•ç‡§µ‡§æ‡§Ç‡§ö‡§æ ‡§á‡§§‡§ø‡§π‡§æ‡§∏</h2>
    <table id="recordsTable">
      <thead>
        <tr>
          <th>‡§§‡§æ‡§∞‡•Ä‡§ñ</th>
          <th>‡§∞‡§ï‡•ç‡§ï‡§Æ (‚Çπ)</th>
          <th>‡§™‡•ç‡§∞‡§ï‡§æ‡§∞</th>
          <th>‡§®‡•ã‡§Ç‡§¶</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h2>üìä ‡§ö‡§æ‡§∞‡•ç‡§ü‡•ç‡§∏</h2>
    <div class="charts">
      <canvas id="pieChart" height="200"></canvas>
      <canvas id="barChart" height="200"></canvas>
    </div>
  </div>

  <script>
    // üîê Firebase Config (‡§§‡•Å‡§ù‡§Ç)
    const firebaseConfig = {
      apiKey: "AIzaSyB2CY5tJ9E7yH0sR18xjrHjqEZdhb3Gn7A",
      authDomain: "hanuman-tarun-mandal.firebaseapp.com",
      databaseURL: "https://hanuman-tarun-mandal-default-rtdb.firebaseio.com",
      projectId: "hanuman-tarun-mandal",
      storageBucket: "hanuman-tarun-mandal.firebasestorage.app",
      messagingSenderId: "882742921363",
      appId: "1:882742921363:web:b143f2eb32e48e792c2566",
      measurementId: "G-SZDFEVGEBL"
    };

    // ‚úÖ v8 style
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // UI refs
    const dateEl = document.getElementById('date');
    const amountEl = document.getElementById('amount');
    const noteEl = document.getElementById('note');
    const typeEl = document.getElementById('type');
    const addBtn = document.getElementById('addBtn');
    const csvBtn = document.getElementById('csvBtn');
    const statusEl = document.getElementById('status');
    const balanceEl = document.getElementById('balance');
    const tbody = document.querySelector('#recordsTable tbody');

    // Totals/State
    let totalCredit = 0, totalDebit = 0;
    let monthlyCredit = {}, monthlyDebit = {};
    let allRecords = [];

    // Charts
    const pieCtx = document.getElementById('pieChart').getContext('2d');
    const barCtx = document.getElementById('barChart').getContext('2d');
    const pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: { labels: ['‡§Ü‡§µ‡§ï', '‡§ñ‡§∞‡•ç‡§ö'], datasets: [{ data: [0,0], backgroundColor: ['#4CAF50','#FF4444'] }] }
    });
    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: { labels: [], datasets: [
        { label: '‡§Ü‡§µ‡§ï', data: [], backgroundColor: '#4CAF50' },
        { label: '‡§ñ‡§∞‡•ç‡§ö', data: [], backgroundColor: '#FF4444' }
      ]},
      options: { scales: { y: { beginAtZero: true } } }
    });

    // Add record (with promise-based set to catch errors)
    addBtn.addEventListener('click', async () => {
      const date = dateEl.value;
      const amount = parseFloat(amountEl.value);
      const note = noteEl.value.trim();
      const type = typeEl.value;

      if(!date || !amount || !note){
        statusEl.textContent = '‚ùó ‡§ï‡•É‡§™‡§Ø‡§æ ‡§§‡§æ‡§∞‡•Ä‡§ñ, ‡§∞‡§ï‡•ç‡§ï‡§Æ ‡§Ü‡§£‡§ø ‡§®‡•ã‡§Ç‡§¶ ‡§≠‡§∞‡§æ.';
        return;
      }

      try {
        const newRef = db.ref('records').push();
        await newRef.set({ date, amount, note, type });
        statusEl.textContent = '‚úÖ ‡§®‡•ã‡§Ç‡§¶ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•Ä.';
        dateEl.value = ''; amountEl.value = ''; noteEl.value = '';
      } catch (err) {
        statusEl.textContent = '‚ùå ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§§‡§æ‡§®‡§æ ‡§§‡•ç‡§∞‡•Å‡§ü‡•Ä: ' + err.message;
        console.error(err);
      }
    });

    // Rebuild table & charts whenever data changes
    db.ref('records').on('value', (snap) => {
      // Reset
      tbody.innerHTML = '';
      totalCredit = 0; totalDebit = 0;
      monthlyCredit = {}; monthlyDebit = {};
      allRecords = [];

      snap.forEach(child => {
        const r = child.val();
        // Row
        const tr = document.createElement('tr');
        tr.className = (r.type === 'credit') ? 'credit' : 'debit';
        tr.innerHTML =
          `<td>${r.date||''}</td>
           <td>‚Çπ${Number(r.amount||0)}</td>
           <td>${r.type==='credit'?'‡§Ü‡§µ‡§ï':'‡§ñ‡§∞‡•ç‡§ö'}</td>
           <td>${r.note||''}</td>`;
        tbody.appendChild(tr);

        // Totals
        const amt = Number(r.amount||0);
        if (r.type === 'credit') { totalCredit += amt; }
        else { totalDebit += amt; }

        // Month aggregates
        const m = (r.date||'').substring(0,7); // YYYY-MM
        if (r.type === 'credit') monthlyCredit[m] = (monthlyCredit[m]||0)+amt;
        else monthlyDebit[m] = (monthlyDebit[m]||0)+amt;

        // CSV
        allRecords.push([r.date, amt, (r.type==='credit'?'‡§Ü‡§µ‡§ï':'‡§ñ‡§∞‡•ç‡§ö'), r.note]);
      });

      // Balance
      const balance = totalCredit - totalDebit;
      balanceEl.textContent = '‡§∂‡§ø‡§≤‡•ç‡§≤‡§ï: ‚Çπ' + balance;

      // Pie update
      pieChart.data.datasets[0].data = [totalCredit, totalDebit];
      pieChart.update();

      // Bar update
      const labels = Array.from(new Set([...Object.keys(monthlyCredit), ...Object.keys(monthlyDebit)])).sort();
      barChart.data.labels = labels;
      barChart.data.datasets[0].data = labels.map(m => monthlyCredit[m]||0);
      barChart.data.datasets[1].data = labels.map(m => monthlyDebit[m]||0);
      barChart.update();
    });

    // CSV download
    csvBtn.addEventListener('click', () => {
      let csv = "‡§§‡§æ‡§∞‡•Ä‡§ñ,‡§∞‡§ï‡•ç‡§ï‡§Æ,‡§™‡•ç‡§∞‡§ï‡§æ‡§∞,‡§®‡•ã‡§Ç‡§¶\n" + allRecords.map(r => r.map(x => {
        const s = (x ?? '').toString().replace(/"/g,'""');
        return /[,\"\n]/.test(s) ? `"${s}"` : s;
      }).join(',')).join('\n');

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'mandal_history.csv';
      document.body.appendChild(a); a.click();
      URL.revokeObjectURL(url); a.remove();
    });
  </script>
</body>
</html>
